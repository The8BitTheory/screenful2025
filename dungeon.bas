#RetroDevStudio.MetaData.BASIC:8193,BASIC 65,uppercase,10,10
10 E=8205:REM111111111111157710040001177710010191177003016151111011011111100:01;00401101100011101195104001001111110111311190010103:0112100;001081111111111111
20 REM00111708807177880111170711717717817177871122261771626677021216061222261622626626726266768272768622333526625355661323251523333525335355356353556573636575

#  P:
#  B:
30 BANK0:P=130:B=12

#  V:TRANSFORMATION VALUES FROM 2D TO 3D. USED FOR CHECKING WHICH ELEMENTS ARE VISIBLE
#  D:ELEMENTS TO DRAW (THE VECTOR GRAPHICS). D(ELEMENT-ID,COORDINATE)
#  P:MOVEMENT OFFSETS, DEPENDING ON ORIENTATION
40 DIM V(75),D(19,7),P(7),M(143)

#  FUNCTION DEFINITIONS
#  CHECK IF GIVEN MAP-TILE IS BLOCKING
#50 DEF FN M(Z)=(PEEK(E+P+V(F*19+Z-1))-48)=1
50 DEF FN M(Z)=(M(P+V(F*19+Z-1))-48)=1

#  GET VALUE OF GIVEN MAP-TILE
60 DEF FN P(Z)=PEEK(E+Z)-48

#  GET NEW ORIENTATION VALUE
70 DEF FN F(Z)=MOD(F+Z+4,4)

#  READ ORIENTATION-DEPENDENT MOVEMENT OFFSETS P()
80 FOR X=0 TO 7
90  READ M
100  P(X)=M
110 NEXT

#   TRANSFORMATION VALUES 2D TO 3D V()
120 FOR X=0 TO 75
130  READ M
140  V(X)=M-37
150 NEXT

#   THE ELEMENTS TO DRAW D()
#   DIMENSION 1: THE ELEMENT-ID
#   DIMENSION 2: THE COORDINATE (X OR Y FOR ONE OF THE 4 VERTICES)
160 M=0
170 FOR X=1 TO 19
180  FOR Y=0 TO 7
190   D(X,Y)=FN P(150+M)*(40+((MOD(Y,2)=0)*-B))
200   M=M+1
210  NEXT
220 NEXT

#   READ MAPDATA M()
221 FOR X=0 TO 143
222  READ M
223  M(X)=M
224 NEXT

######################################################

#   SETUP GRAPHICS MODE
230 SCREEN 640,400,2

#   RENDER INITIAL VIEW
240 GOTO 280

#   GAME LOOP
250 GETKEY I$
260 I=ASC(I$):F=FNF((I=81)+ABS(I=69))
270 IF I=65 OR I=68 THEN N=ABS(I=68):F=FNF(3):GOSUB 490:F=FNF(5):F=FNF(Q=3):ELSEIF I=87 OR I=83 THEN N=ABS(I=83):GOSUB490:F=FNF(Q=3)

#   ANALYZE VISIBLE ELEMENTS
280 R=0
290 C$="ACH":GOSUB 400
300 C$="BEL":GOSUB 400

#   CHECK NEXT CENTERPIECE
310 GOSUB 330

#   ANALYSIS DONE. JUMP TO RENDERING PART
320 R(R)=0:GOTO 550

######################################################

#   CHECK NEAR ELEMENTS
330 IF FNM(4) THEN R(R)=4:R=R+1:RETURN
340 C$="FIO":GOSUB400:C$="GKS":GOSUB400:GOSUB350:RETURN

#   CHECK FAR ELEMENTS
350 IF FNM(10) THEN R(R)=10:R=R+1:RETURN

360 C$="MP":GOSUB400
370 C$="NR":GOSUB400

#   CHECK BEYOND ELEMENTS
380 IF FN M(17) THEN R(R)=17:R=R+1
390 RETURN

#   ADD VISIBLE ELEMENTS TO RENDERLIST
400 G=1
410 DO
420  C=ASC(MID$(C$,G,1))-64
430  S=FN M(C)
440  IF S THEN R(R)=C:R=R+1
450  G=G+1
460  IF G>LEN(C$) THEN EXIT
470 LOOP WHILE S>=0
480 RETURN

######################################################

#   PROCESS MOVEMENT
490 T=P
500 P=P+P(F+F+N)
510 Q=FNP(P)
520 L=(Q=1)*T+(Q=2)*44
530 P=(L<0)*L+(L=0)*-P
540 RETURN

#######################################################

#   CLEAR SCREEN, DRAW BOX FRAME
550 SCNCLR0:BOX0,0,416,320,0

#   WRITE COMPASS
560 CHAR24,8,2,2,2,MID$("",F+1,1)

#   ITERATE RENDERLIST AND DRAW VISIBLE ELEMENTS
570 R=0
580 DO
590  D=R(R)
600  BOX D(D,0),D(D,1),D(D,2),D(D,3),D(D,4),D(D,5),D(D,6),D(D,7),0
610  R=R+1
620 LOOP WHILE D>0

630 CHAR18,352,2,2,2,MID$("E URIOUS  UST MAGINEOME LOSER EYS:  OZY LACEEELS EIRD!Y OODWELL E INDFUL  EELS IZZY!",(11-FNP(P))*B+1,B)

640 GOTO250


#   WRITTEN TO P()
650 DATA -12,12,1,-1,12,-12,-1,1

#   WRITEN TO V()
660 DATA 36,38,24,25,26
670 DATA 24,26,12,12,13,14,14,12,14,,,1,2,2,25,49
680 DATA 26,38,50,26,50,27,27,39,51
690 DATA 51,27,51,28,28,40,52,52,38,36,50,49,48
700 DATA 50,48,62,62,61
710 DATA 60,60,62,60,74,74,73
720 DATA 72,72,49,25,48,36,24,48,24,47,47,35,23,23,47,23,46,46,34,22,22

#   WRITTEN TO M()
730 DATA 1,1,1,1,1,1,1,1,1,1,1,1
740 DATA 1,5,7,7,1,0,0,4,0,0,0,1
750 DATA 1,7,7,7,1,0,0,1,0,1,9,1
760 DATA 1,7,7,0,0,3,0,1,6,1,5,1
770 DATA 1,1,1,0,1,1,0,1,1,1,1,1
780 DATA 1,0,0,0,0,1,0,0,0,4,0,1
790 DATA 1,0,1,1,0,0,0,1,1,1,0,1
800 DATA 1,9,5,1,0,4,0,0,1,0,0,1
810 DATA 1,1,1,1,1,0,1,1,1,3,1,1
820 DATA 1,9,0,0,1,0,1,0,3,0,0,1
830 DATA 1,2,1,0,0,0,0,0,1,0,8,1
840 DATA 1,1,1,1,1,1,1,1,1,1,1,1